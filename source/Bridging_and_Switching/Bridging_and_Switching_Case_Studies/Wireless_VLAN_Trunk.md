# 概述

一个非常常见的任务是在无线点对点（PtP）链路上只转发某一组VLAN。自RouterOS v6.41以来，这可以通过网桥VLAN过滤来实现，并且应该用它来代替任何其他方法（包括桥接VLAN接口）。比如，我们需要通过无线链路转发到2个不同的VLAN，所有其他的VLAN ID应该被丢弃。VLAN 10是我们的互联网流量，而VLAN 99是我们的管理流量。下面是网络拓扑结构。

![](https://help.mikrotik.com/docs/download/attachments/122388482/Wlan_trunk.jpg?version=1&modificationDate=1653919647235&api=v2)

# 配置

首先在 **AP** 和 **ST** 上创建一个新的网桥，并向其添加 **ether1** 和 **wlan1** 端口。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface bridge</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">name</code><code class="ros plain">=bridge</code> <code class="ros value">protocol-mode</code><code class="ros plain">=none</code></div><div class="line number3 index2 alt2" data-bidi-marker="true"><code class="ros constants">/interface bridge port</code></div><div class="line number4 index3 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">bridge</code><code class="ros plain">=bridge</code> <code class="ros value">interface</code><code class="ros plain">=ether1</code></div><div class="line number5 index4 alt2" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">bridge</code><code class="ros plain">=bridge</code> <code class="ros value">interface</code><code class="ros plain">=wlan1</code></div></div></td></tr></tbody></table>
  
如果需要的话，可以启用 RSTP，但一般来说，PtP 链接不需要 RSTP，因为不应该发生环路。
  
为了安全起见，应该启用入站过滤，因为你只希望有标记的流量，可以设置网桥过滤掉所有未标记的流量。在 **AP** 和 **ST** 上进行如下操作。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface bridge port</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">set </code><code class="ros plain">[</code><code class="ros functions">find </code><code class="ros plain">where </code><code class="ros value">interface</code><code class="ros plain">=ether1</code> <code class="ros variable">or</code> <code class="ros value">interface</code><code class="ros plain">=wlan1]</code> <code class="ros value">frame-types</code><code class="ros plain">=admit-only-vlan-tagged</code> <code class="ros value">ingress-filtering</code><code class="ros plain">=yes</code></div></div></td></tr></tbody></table>
  
设置网桥VLAN表。由于 VLAN99 是管理流量，那么需要允许这个 VLAN ID 能够访问网桥接口，否则，当你试图访问设备时，流量就会被丢弃。VLAN10 不需要访问网桥，因为它只是被转发到另一端。为了实现这样的功能，在 **AP** 和 **ST** 的网桥 VLAN 表中加入这些项。
  
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface bridge vlan</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">bridge</code><code class="ros plain">=bridge</code> <code class="ros value">tagged</code><code class="ros plain">=ether1,wlan1</code> <code class="ros value">vlan-ids</code><code class="ros plain">=10</code></div><div class="line number3 index2 alt2" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">bridge</code><code class="ros plain">=bridge</code> <code class="ros value">tagged</code><code class="ros plain">=ether1,wlan1,bridge</code> <code class="ros value">vlan-ids</code><code class="ros plain">=99</code></div></div></td></tr></tbody></table>
  
您可以限制允许从哪些接口访问设备。例如， 如果您不希望设备从 `wlan1` 被访问， 那么您可以从相应的网桥 VLAN 项中删除该接口。

对于有[硬件卸载VLAN过滤](https://help.mikrotik.com/docs/display/ROS/Bridging+and+Switching#BridgingandSwitching-BridgeHardwareOffloading)和无线接口支持的设备(如RB4011带RTL8367交换芯片，或LtAP带MT7621交换芯片)，需要更加注意。如果不允许VLAN访问CPU，从HW卸载端口到无线的数据包可以被过滤掉。可以通过将网桥接口添加为VLAN成员（类似于VLAN99的例子）或禁用网桥端口的HW卸载来允许某个VLAN的CPU访问。
  
所有设备（**R1**，**R2**，**AP，**和**ST**）都需要创建一个VLAN接口，以便能够通过特定的VLAN ID访问设备。对于**AP**和**ST**来说，在网桥接口之上创建VLAN接口，并给它分配一个IP地址。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface vlan</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">interface</code><code class="ros plain">=bridge</code> <code class="ros value">name</code><code class="ros plain">=MGMT</code> <code class="ros value">vlan-id</code><code class="ros plain">=99</code></div><div class="line number3 index2 alt2" data-bidi-marker="true"><code class="ros constants">/ip address</code></div><div class="line number4 index3 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">address</code><code class="ros plain">=192.168.99.X/24</code> <code class="ros value">interface</code><code class="ros plain">=MGMT</code></div></div></td></tr></tbody></table>

对于**R1**和**R2**做同样的事情，但创建VLAN接口的接口可能会改变，这取决于你的设置。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface vlan</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">interface</code><code class="ros plain">=ether1</code> <code class="ros value">name</code><code class="ros plain">=MGMT</code> <code class="ros value">vlan-id</code><code class="ros plain">=99</code></div><div class="line number3 index2 alt2" data-bidi-marker="true"><code class="ros constants">/ip address</code></div><div class="line number4 index3 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">address</code><code class="ros plain">=192.168.99.X/24</code> <code class="ros value">interface</code><code class="ros plain">=MGMT</code></div></div></td></tr></tbody></table>
  
要允许更多的VLAN被转发，你只需要在网桥VLAN表中指定更多的VLAN ID，可以指定多个用coma甚至VLAN范围划分的VLAN。
  
在**AP**上设置无线链接。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface wireless security-profiles</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">authentication-types</code><code class="ros plain">=wpa2-psk</code> <code class="ros value">mode</code><code class="ros plain">=dynamic-keys</code> <code class="ros value">name</code><code class="ros plain">=wlan_sec</code> <code class="ros value">wpa2-pre-shared-key</code><code class="ros plain">=use_a_long_password_here</code></div><div class="line number3 index2 alt2" data-bidi-marker="true"><code class="ros constants">/interface wireless</code></div><div class="line number4 index3 alt1" data-bidi-marker="true"><code class="ros functions">set </code><code class="ros plain">wlan1 </code><code class="ros value">band</code><code class="ros plain">=5ghz-a/n/ac</code> <code class="ros value">channel-width</code><code class="ros plain">=20/40/80mhz-Ceee</code> <code class="ros value">disabled</code><code class="ros plain">=no</code> <code class="ros value">mode</code><code class="ros plain">=bridge</code> <code class="ros value">scan-list</code><code class="ros plain">=5180</code> <code class="ros value">security-profile</code><code class="ros plain">=wlan_sec</code> <code class="ros value">ssid</code><code class="ros plain">=ptp_test</code></div></div></td></tr></tbody></table>

在**ST**上设置无线链接。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface wireless security-profiles</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">add </code><code class="ros value">authentication-types</code><code class="ros plain">=wpa2-psk</code> <code class="ros value">mode</code><code class="ros plain">=dynamic-keys</code> <code class="ros value">name</code><code class="ros plain">=wlan_sec</code> <code class="ros value">wpa2-pre-shared-key</code><code class="ros plain">=use_a_long_password_here</code></div><div class="line number3 index2 alt2" data-bidi-marker="true"><code class="ros constants">/interface wireless</code></div><div class="line number4 index3 alt1" data-bidi-marker="true"><code class="ros functions">set </code><code class="ros plain">wlan1 </code><code class="ros value">band</code><code class="ros plain">=5ghz-a/n/ac</code> <code class="ros value">channel-width</code><code class="ros plain">=20/40/80mhz-Ceee</code> <code class="ros value">disabled</code><code class="ros plain">=no</code> <code class="ros value">mode</code><code class="ros plain">=station-bridge</code> <code class="ros value">scan-list</code><code class="ros plain">=5180</code> <code class="ros value">security-profile</code><code class="ros plain">=wlan_sec</code> <code class="ros value">ssid</code><code class="ros plain">=ptp_test</code></div></div></td></tr></tbody></table>
  
对于每一种类型的设置，都有不同的要求，对于PtP链接，通常使用NV2无线协议。你可以在[NV2手册](https://wiki.mikrotik.com/wiki/Manual:Nv2 "Manual:Nv2")上阅读更多关于NV2的信息。

当链接设置好后，你可以在**AP**和**ST**上启用网桥VLAN过滤。

<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2" data-bidi-marker="true"><code class="ros constants">/interface bridge</code></div><div class="line number2 index1 alt1" data-bidi-marker="true"><code class="ros functions">set </code><code class="ros plain">bridge </code><code class="ros value">vlan-filtering</code><code class="ros plain">=yes</code></div></div></td></tr></tbody></table>
  
在启用 VLAN 过滤之前，请仔细检查网桥 VLAN 表。错误配置的网桥VLAN表会导致设备无法访问，可能需要重置配置。
